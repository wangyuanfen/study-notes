TCP/IP传输协议是严格来说是一个四层的体系结构，应用层、传输层、网络层和数据链路层。每一层都由特定的协议与对方进行通信，而协议之间的通信最终都要转化为 0 和 1 的电信号，通过物理介质进行传输才能到达对方的电脑，因此物理介质是网络通信的基石。

## 数据链路层
局域网使用广播信道(可以一对多通信)

计算机与局域网的连接是通过适配器进行的。以太网规协议定，接入网络的设备都必须安装网络适配器，即网卡，数据包必须是从一块网卡传送到另一块网卡。

网卡地址就是数据帧的发送地址和接收地址，也就是帧首部所包含的MAC地址，MAC地址是每块网卡的身份标识，具有全球唯一性。

有了MAC地址以后，以太网采用广播形式，把数据帧发给该其他适配器，适配器接收到这个包以后，都会读取首部里的目标MAC地址，然后和自己的MAC地址进行对比，如果相同就做下一步处理，如果不同，就丢弃这个帧。

链路层的主要工作就是对电信号进行分组并形成具有特定意义的数据帧，然后以广播的形式通过物理介质发送给接收方。

## 网络层
负责为分组交换网上的不同主机提供通信服务。在发送数据时，网络层会把运输层产生的报文段或用户数据报封装成分组或包进行传送。

在TCP/IP体系中，网络层使用IP协议，因此分组也叫**IP数据报**或者称为**数据报**。

**负责传输的 IP 协议**

IP 协议的作用是把各种数据包传送给对方。而要保证确实传送到对方那里，则需要满足各类条件。其中两个重要的条件是 IP 地址和 MAC 地址（Media Access Control Address）。

IP 地址指明了节点被分配到的地址，MAC 地址是指网卡所属的固定地址。IP 地址可以和 MAC 地址进行配对。IP 地址可变换，但 MAC 地址基本上不会更改。

使用 ARP 协议凭借 MAC 地址进行通信

IP 间的通信依赖 MAC 地址。在网络上，通信的双方在同一局域网 （LAN）内的情况是很少的，通常是经过多台计算机和网络设备中转 才能连接到对方。而在进行中转时，会利用下一站中转设备的 MAC 地址来搜索下一个中转目标。这时，会采用 ARP 协议（Address Resolution Protocol）。ARP 是一种用以解析地址的协议，根据通信方 的 IP 地址就可以反查出对应的 MAC 地址。

## 传输层
负责向两台主机中进程之间的通信提供通用的数据传输服务。**应用进程**利用该服务**传送应用层报文**。

主要使用以下两种协议:
* 用户数据协议UDP- UDP协议定义了端口，同一个主机上的每个应用程序都需要指定唯一的端口号，并且规定网络中传输的数据包必须加上端口信息，当数据包到达主机以后，就可以根据端口号找到对应的应用程序了。UDP协议比较简单，实现容易，但它没有确认机制，数据包一旦发出，无法知道对方是否收到，因此可靠性较差，为了解决这个问题，提高网络可靠性，TCP协议就诞生了。
    * 建立一个 TCP 连接时，采用了三次握手 （three-way handshaking）
      * 第一次握手(SYN=1, seq=x)
        客户端发送一个 TCP 的 SYN 标志位置1的包，指明客户端打算连接的服务器的端口，以及初始序号 X,保存在包头的序列号(Sequence Number)字段里。         发送完毕后，客户端进入 SYN_SEND 状态。
      * 第二次握手(SYN=1, ACK=1, seq=y, ACKnum=x+1)
        服务器发回确认包(ACK)应答。即 SYN 标志位和 ACK 标志位均为1。服务器端选择自己 ISN 序列号，放到 Seq 域里，同时将确认序号(Acknowledgement Number)设置为客户的 ISN 加1，即X+1。 发送完毕后，服务器端进入 SYN_RCVD 状态。
      * 第三次握手(ACK=1，ACKnum=y+1)
        客户端再次发送确认包(ACK)，SYN 标志位为0，ACK 标志位为1，并且把服务器发来 ACK 的序号字段+1，放在确定字段中发送给对方，并且在数据段放写ISN的+1  
        发送完毕后，客户端进入 ESTABLISHED 状态，当服务器端接收到这个包时，也进入 ESTABLISHED 状态，TCP 握手结束。
    * TCP 的连接的拆除，采用四次挥手（Four-way handshake）
      * 第一次挥手(FIN=1，seq=x)
        假设客户端想要关闭连接，客户端发送一个 FIN 标志位置为1的包，表示自己已经没有数据可以发送了，但是仍然可以接受数据。  
        发送完毕后，客户端进入 FIN_WAIT_1 状态。
      * 第二次挥手(ACK=1，ACKnum=x+1)
        服务器端确认客户端的 FIN 包，发送一个确认包，表明自己接受到了客户端关闭连接的请求，但还没有准备好关闭连接。  
        发送完毕后，服务器端进入 CLOSE_WAIT 状态，客户端接收到这个确认包之后，进入 FIN_WAIT_2 状态，等待服务器端关闭连接。
      * 第三次挥手(FIN=1，seq=y)
        服务器端准备好关闭连接时，向客户端发送结束连接请求，FIN 置为1。  
        发送完毕后，服务器端进入 LAST_ACK 状态，等待来自客户端的最后一个ACK。
      * 第四次挥手(ACK=1，ACKnum=y+1)
        客户端接收到来自服务器端的关闭请求，发送一个确认包，并进入 TIME_WAIT状态，等待可能出现的要求重传的 ACK 包。  
        服务器端接收到这个确认包之后，关闭连接，进入 CLOSED 状态。  
        客户端等待了某个固定时间（两个最大段生命周期，2MSL，2 Maximum Segment Lifetime）之后，没有收到服务器端的 ACK ，认为服务器端已经正常关闭连接，于是自己也关闭连接，进入 CLOSED 状态。
* 传输控制协议TCP- TCP即传输控制协议，是一种面向连接的、可靠的、基于字节流的通信协议。简单来说TCP就是有确认机制的UDP协议，每发出一个数据包都要求确认，如果有一个数据包丢失，就收不到确认，发送方就必须重发这个数据包。为了保证传输的可靠性，TCP协议在UDP基础之上建立了三次对话的确认机制，即在正式收发数据前，必须和对方建立可靠的连接。TCP数据包和UDP一样，都是由首部和数据两部分组成，唯一不同的是，TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

## 应用层
通过应用进程间的交互完成特定网络应用，决定了向用户提供应用服务时的通信活动。这里的进程指的是运行中的程序。对不同种类的应用程序它们会根据自己的需要来使用应用层的不同协议，邮件传输应用使用了SMTP协议、万维网应用使用了HTTP协议、远程登录服务应用使用了有TELNET协议。

应用层交互的数据单元称为**报文**

## 基本框架
![](https://github.com/wangyuanfen/study-notes/blob/master/image/1567220295773.jpg?raw=true)
当通过http发起一个请求时，应用层、传输层、网络层和链路层的相关协议依次对该请求进行包装并携带对应的首部，最终在链路层生成以太网数据包，以太网数据包通过物理介质传输给对方主机，对方接收到数据包以后，然后再一层一层采用对应的协议进行拆包，最后把应用层数据交给应用程序处理。

[深入浅出 TCP/IP 协议栈](https://www.cnblogs.com/onepixel/p/7092302.html)

[一篇文章带你熟悉 TCP/IP 协议](https://juejin.im/post/5a069b6d51882509e5432656)
